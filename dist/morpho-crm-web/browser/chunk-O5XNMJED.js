import{a as A}from"./chunk-C3RZJLGD.js";import{a as V,b as x,c as N,d as Q}from"./chunk-DZ2SWEVM.js";import"./chunk-J65LRALL.js";import{a as k}from"./chunk-Q7BWANAG.js";import{a as D}from"./chunk-VIJ5AVWV.js";import{a as E}from"./chunk-ZZ24IKKX.js";import{a as P}from"./chunk-IFSTEAGB.js";import{a as O}from"./chunk-62CHZGYY.js";import"./chunk-BYXBJQAS.js";import{a as R}from"./chunk-T4HB4AXC.js";import{T,q as F,w as M}from"./chunk-YMK4QOIO.js";import{$ as d,Ab as L,Db as h,Ob as w,Pa as _,V as f,_ as s,a as b,b as y,gb as u,hb as n,ib as o,jb as C,pb as I,tb as m,yb as g,za as c,zb as v}from"./chunk-MI4VSIZJ.js";var q=["leadStatusChangeModal"],U=["leadInteractionModal"],z=["leadConversionReviewModal"],B=()=>({multiSelect:!1,rowReferenceField:"leadId"}),S=class p{leadStatusChangeModal;leadInteractionModal;leadConversionReviewModal;leadsInteractionMasterService=f(D);constructor(){this.setLeadLookupData()}router=f(F);leadsService=f(O);toastService=f(M);pageBreadcrumbs=[{label:"Home",path:"/"},{label:"Leads",path:"/leads"}];leads=[];columns=[{field:"leadId",label:"Lead ID",hidden:!0},{field:"leadTopic",label:"Lead Topic",cellTemplate:"link",hrefField:"/leads/detail/:leadId"},{field:"leadOwner.FirstName",label:"Name"},{field:"phone",label:"Phone"},{field:"leadStatus",label:"Lead Status",cellTemplate:"color-badge",colorBadgeMapper:Q},{field:"createdAt",label:"Created Time",cellTemplate:"datetime"}];loading=!1;currentPage=1;pageSize=10;totalRecords=0;searchQuery="";eagerFetch=!0;leadSourcesOptions=[];leadStatusOptions=[];filters=[{field:"leadStatus",label:"Lead Status",value:"",type:"select",options:this.leadStatusOptions},{field:"leadSource",label:"Lead Source",value:"",type:"select",options:this.leadSourcesOptions},{field:"ConvertedAt",label:"Converted At",value:null,type:"date"},{field:"createdAt",label:"Created At",value:null,type:"date"}];filterData={filters:this.filters,config:{}};apiReadyFilterData=[];selectedLeadForAction=null;tableRowActions=[{label:"View",actionCallback:e=>{console.log("View Details clicked for:",e),this.router.navigate(["/leads/detail",e.leadId])}},{label:"Edit",actionCallback:e=>{console.log("Edit clicked for:",e),this.router.navigate(["/leads/form"],{queryParams:{leadId:e.leadId}})}},{label:"Update Status",actionCallback:e=>{console.log("clicked for:",e),this.selectedLeadForAction=e,this.openLeadStatusChangeDialog()}},{label:"Add Interaction",actionCallback:e=>{console.log("clicked for:",e),this.selectedLeadIdForInteraction=e.leadId,this.openLeadInteractionForm(e.leadId)}},{label:"Convert to Opportunity",actionCallback:e=>{console.log("Convert to Opportunity clicked for:",e),this.openLeadConversionReviewModal(e)}}];leadInteractionTypes=[];ngOnInit(){this.loadLeadInteractionTypes(),this.loadLeads()}setLeadLookupData(){this.getLeadStatuses(),this.getLeadSources()}getLeadSources(){this.leadsService.getLeadSources().subscribe({next:e=>{this.leadSourcesOptions=e.map(t=>({label:t.sourceName,value:t.sourceId})),this.filters=this.filters.map(t=>t.field==="leadSource"?y(b({},t),{options:this.leadSourcesOptions}):t),this.filterData={filters:this.filters,config:{}}},error:e=>{console.error("Error fetching lead sources:",e)}})}getLeadStatuses(){this.leadsService.getLeadsLookupData().subscribe({next:e=>{this.leadStatusOptions=e.leadStatuses.map(t=>({label:t.label,value:t.value})),this.filters=this.filters.map(t=>t.field==="leadStatus"?y(b({},t),{options:this.leadStatusOptions}):t),this.filterData={filters:this.filters,config:{}}},error:e=>{console.error("Error fetching lead statuses:",e)}})}loadLeads(){this.loading=!0;let e={field:"createdAt",order:"desc"};this.leadsService.getLeads(this.searchQuery,this.apiReadyFilterData,e,this.currentPage,this.pageSize,this.eagerFetch).subscribe({next:t=>{let a=t?.data||[];this.totalRecords=t?.total||a.length,this.leads=R.mapDataToColumns(a,this.columns),this.loading=!1},error:t=>{this.loading=!1}})}loadLeadInteractionTypes(){this.leadsInteractionMasterService.getLeadInteractionTypes().subscribe(e=>{this.leadInteractionTypes=e})}onPageChangeHandler(e){this.currentPage=e,this.loadLeads()}onSearchChange(e){this.searchQuery=e,this.currentPage=1,this.loadLeads()}onFilterChange(e){if(!e||e.length===0){this.apiReadyFilterData=[],this.currentPage=1,this.loadLeads();return}let a=e.filter(i=>i.value).map(i=>{let r="contains";return i.type==="select"&&(r="equals"),i.type==="date"&&(r="equals"),i.type==="multiselect"&&(r="list"),{field:i.field,value:i.value,type:r}});this.apiReadyFilterData=a,this.currentPage=1,this.loadLeads()}onCreateLead(){this.router.navigate(["/leads/form"])}openLeadStatusChangeDialog(){this.leadStatusChangeModal.open()}closeLeadStatusChangeDialog(){this.leadStatusChangeModal.close(),this.selectedLeadForAction=null}handleLeadStatusUpdate(e){if(!this.selectedLeadForAction){this.toastService.error("No lead selected for status update.");return}if(!e){this.toastService.error("Please select a valid status.");return}this.leadsService.updateLeadStatus(this.selectedLeadForAction.leadId,e).subscribe({next:t=>{if(t&&t.leadId){this.closeLeadStatusChangeDialog(),this.loadLeads();return}},error:t=>{console.error("Error updating lead status:",t)}})}selectedLeadIdForInteraction="";onInteractionSubmit(e){this.leadsService.createLeadInteraction(this.selectedLeadIdForInteraction,e).subscribe({next:t=>{if(t.interactionId){this.toastService.success("Lead interaction created successfully."),this.leadInteractionModal.close();return}this.toastService.error("Failed to create lead interaction. Please try again later.")},error:t=>{console.error("Error creating lead interaction:",t)}})}openLeadInteractionForm(e){this.selectedLeadIdForInteraction=e,this.leadInteractionModal.open()}closeLeadInteractionForm(){this.leadInteractionModal.close()}selectedLeadForConversion=null;openLeadConversionReviewModal(e){this.selectedLeadForConversion=e,this.leadConversionReviewModal.open()}closeLeadConversionReviewModal(){this.leadConversionReviewModal.close()}onLeadConversionSubmit(e){if(!this.selectedLeadForConversion){this.toastService.error("No lead selected for conversion.");return}if(!this.selectedLeadForConversion.leadId){this.toastService.error("Invalid lead selected for conversion. Sorry for the inconvenience.");return}let t={leadId:this.selectedLeadForConversion.leadId};e.useExistingAccount?t.companyName=e.accountName:t.companyName=e.companyName,e.useExistingContact?t.firstName=e.contactName:t.firstName=e.leadName,this.leadsService.updateLead(t).subscribe({next:a=>{if(console.log("Lead update before conversion response:",a),!a||!a.leadId){console.error("Lead update failed or invalid response:",a);return}if(!this.selectedLeadForConversion){this.toastService.error("No lead selected for conversion.");return}this.leadsService.convertLeadToCustomer(this.selectedLeadForConversion.leadId,!0).subscribe({next:i=>{if(console.log("Lead convert response:",i),i?.isMergeConfirmedRequired){this.toastService.error("Lead conversion requires merge confirmation. Please try again.");return}if(i?.converted)this.toastService.success("Lead converted to customer successfully.");else{this.toastService.error("Lead conversion failed. Please try again later.");return}this.leadConversionReviewModal.close(),this.loadLeads()},error:i=>{console.error("Error converting lead:",i),this.toastService.error("Failed to convert lead. Please try again later.")}})},error:a=>{console.error("Error updating lead:",a),this.toastService.error("Failed to update lead. Please try again later.")}})}static \u0275fac=function(t){return new(t||p)};static \u0275cmp=_({type:p,selectors:[["app-lead-listing"]],viewQuery:function(t,a){if(t&1&&(g(q,5),g(U,5),g(z,5)),t&2){let i;v(i=L())&&(a.leadStatusChangeModal=i.first),v(i=L())&&(a.leadInteractionModal=i.first),v(i=L())&&(a.leadConversionReviewModal=i.first)}},decls:33,vars:19,consts:[["leadStatusChangeModal",""],["leadInteractionModal",""],["leadConversionReviewModal",""],[1,"px-4","sm:px-6","lg:px-8"],[1,"sm:flex","sm:items-center"],[1,"sm:flex-auto"],[1,""],["description","A list of all the leads in your account including received from various sources and more.",3,"title","breadcrumbs"],[1,"sm:mt-0","sm:ml-16","sm:flex-none"],["type","button",1,"block","rounded-md","bg-primary-500","px-3","py-2","text-center","text-sm","font-semibold","text-white","shadow-xs","hover:bg-primary-500/80","focus-visible:outline-2","focus-visible:outline-offset-2","focus-visible:outline-primary-500","dark:bg-primary-500","dark:hover:bg-indigo-400","dark:focus-visible:outline-primary-500",3,"click"],[3,"pageChange","search","filterChange","records","columns","currentPage","pageSize","totalRecords","filterData","rowActions","tableConfig"],[3,"modalId"],[3,"statusChange","cancel","lead","leadStatusOptions"],[1,"mt-3","text-center","sm:mt-0","sm:text-left"],["id","dialog-title",1,"text-base","font-semibold","text-gray-900","dark:text-white"],[1,"mt-2"],[1,"text-sm","text-gray-500","dark:text-gray-400"],[3,"interactionSubmit","leadId","leadInteractionTypes"],[1,"mt-4"],[3,"formSubmit","leadId"],[1,"mt-5","sm:mt-4","sm:flex","sm:flex-row-reverse"]],template:function(t,a){if(t&1){let i=I();n(0,"div",3)(1,"div",4)(2,"div",5)(3,"div",6),C(4,"app-page-heading",7),o()(),n(5,"div",8)(6,"button",9),m("click",function(){return s(i),d(a.onCreateLead())}),h(7,"Add lead"),o()()(),n(8,"app-custom-datatable",10),m("pageChange",function(l){return s(i),d(a.onPageChangeHandler(l))})("search",function(l){return s(i),d(a.onSearchChange(l))})("filterChange",function(l){return s(i),d(a.onFilterChange(l))}),o()(),n(9,"app-modal-small",11,0)(11,"app-lead-status-change-box",12),m("statusChange",function(l){return s(i),d(a.handleLeadStatusUpdate(l))})("cancel",function(){return s(i),d(a.closeLeadStatusChangeDialog())}),o()(),n(12,"app-modal-small",11,1)(14,"div",13)(15,"h3",14),h(16,"Create Interaction"),o(),n(17,"div",15)(18,"p",16),h(19,"Fill in the details for the interaction:"),o()(),n(20,"div",15)(21,"app-lead-interaction-form",17),m("interactionSubmit",function(l){return s(i),d(a.onInteractionSubmit(l))}),o()()()(),n(22,"app-modal-medium",11,2)(24,"div",13)(25,"h3",14),h(26,"Lead Conversion Review"),o(),n(27,"div",15)(28,"p",16),h(29,"Review lead details before converting to opportunity:"),o()(),n(30,"div",18)(31,"app-lead-conversion-review",19),m("formSubmit",function(l){return s(i),d(a.onLeadConversionSubmit(l))}),o()()(),C(32,"div",20),o()}t&2&&(c(4),u("title","Leads")("breadcrumbs",a.pageBreadcrumbs),c(4),u("records",a.leads)("columns",a.columns)("currentPage",a.currentPage)("pageSize",a.pageSize)("totalRecords",a.totalRecords)("filterData",a.filterData)("rowActions",a.tableRowActions)("tableConfig",w(18,B)),c(),u("modalId","lead-status-change-modal"),c(2),u("lead",a.selectedLeadForAction)("leadStatusOptions",a.leadStatusOptions),c(),u("modalId","lead-interaction-modal"),c(9),u("leadId",a.selectedLeadIdForInteraction)("leadInteractionTypes",a.leadInteractionTypes),c(),u("modalId","lead-conversion-review-modal"),c(9),u("leadId",(a.selectedLeadForConversion==null?null:a.selectedLeadForConversion.leadId)||null))},dependencies:[P,A,E,k,T,x,V,N],encapsulation:2})};var fe=[{path:"",component:S},{path:"form",loadComponent:()=>import("./chunk-JXSNVR6D.js").then(p=>p.LeadsCreateOrUpdate)},{path:"detail/:id",loadComponent:()=>import("./chunk-V3NRM77S.js").then(p=>p.LeadDetailView)}];export{fe as LEADS_ROUTES};
